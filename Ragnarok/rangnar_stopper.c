// R// Author: borja.merino@blackarrow.net
// Version: Ragnarok Stopper v0.1

#include <stdio.h>
#include <windows.h>
#include <Lmcons.h>

#define __ROL__(x, y) _rotl(x, y)
inline unsigned int __ROL4__(unsigned int value, int count) { return __ROL__((unsigned int)value, count); }
inline unsigned int __ROR4__(unsigned int value, int count) { return __ROL__((unsigned int)value, -count); }

LPWSTR GetRegValue(LPCWSTR lpSubKey, LPCWSTR lpValueName)
{
	LPBYTE buffer;
	LPWSTR result;
	DWORD cbData;
	HKEY phkResult;

	cbData = 508;
	buffer = (LPBYTE)VirtualAlloc(0, 0x1FCu, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	if (RegOpenKeyExW(HKEY_LOCAL_MACHINE, lpSubKey, 0, 0x20119u, &phkResult) || RegQueryValueExW(phkResult, lpValueName, 0, 0, buffer, &cbData))
	{
		RegCloseKey(phkResult);
		result = 0;
	}
	else
	{
		RegCloseKey(phkResult);
		result = (LPWSTR)buffer;
	}
	return result;
}

LPWSTR GenerateID(LPCWSTR lpString)
{
	unsigned int inc;
	int len, i, acu;
	LPWSTR codeID;

	inc = 0;
	codeID = (LPWSTR)VirtualAlloc(0, 0x7Fu, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	len = lstrlenW(lpString);
	for (i = 0; i < len; inc = (acu ^ 0xAB01FF3C) + inc - __ROL4__((acu ^ 0xAB01FF3C) + inc, 13))
		acu = lpString[i++];
	wsprintfW(codeID, L"%08X", inc);
	return codeID;
}

void CalculateBot(wchar_t bot_id[])
{
	LPWSTR mGUID_reg;
	LPWSTR procID_reg;
	LPWSTR id_mguid;
	LPWSTR id_procid;
	LPWSTR id_hostname;
	LPWSTR id_username;
	LPWSTR id_concat;
	LPWSTR wcs;
	int msgboxID;
	wchar_t username[UNLEN + 1];
	wchar_t hostname[MAX_COMPUTERNAME_LENGTH + 1];

	mGUID_reg = GetRegValue(L"SOFTWARE\\Microsoft\\Cryptography", L"MachineGuid");
	if (mGUID_reg == 0) {
		wprintf(L"[-] Failed to get MachineGUID");
		exit(1);
	}

	procID_reg = GetRegValue(L"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion", L"ProductName");
	if (procID_reg == 0) {
		wprintf(L"[-] Failed to get procID_reg");
		exit(1);
	}

	DWORD len = sizeof(username) / sizeof(wchar_t);
	int r = GetUserNameW(username, &len);

	if (r == 0) {
		wprintf(L"[-] Failed to get Username %ld", GetLastError());
		exit(1);
	}

	len = sizeof(hostname) / sizeof(wchar_t);
	r = GetComputerNameW(hostname, &len);

	if (r == 0) {
		wprintf(L"[-] Failed to get hostname %ld", GetLastError());
		exit(1);
	}

	wcs = (LPWSTR)VirtualAlloc(0, 0xBAEu, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);

	wcscpy(wcs, (wchar_t*)mGUID_reg);
	wcscat(wcs, (wchar_t*)procID_reg);
	wcscat(wcs, username);
	wcscat(wcs, hostname);

	//wprintf(L"[*] Machine GUID: %ls\n", mGUID_reg);
	//wprintf(L"[*] Product ID: %ls\n", procID_reg);
	//wprintf(L"[*] User name: %ls\n", username);
	//wprintf(L"[*] Hostname: %ls\n", hostname);
	//wprintf(L"[*] Concatenated: %ls\n", wcs);

	/*--ID(MACHINE GUID)-ID(PRODUCT ID)-ID(USERNAME)-ID(HOSTNAME)-ID(CONCATENATION) */
	id_username = GenerateID(username);
	id_hostname = GenerateID(hostname);
	id_mguid = GenerateID(mGUID_reg);
	id_procid = GenerateID(procID_reg);
	id_concat = GenerateID(wcs);

	wsprintfW(bot_id, L"%s-%s-%s-%s-%s", id_mguid, id_procid, id_username, id_hostname, id_concat);
	VirtualFree(mGUID_reg, 0, MEM_RELEASE);
	VirtualFree(procID_reg, 0, MEM_RELEASE);
	VirtualFree(wcs, 0, MEM_RELEASE);
}

void HideConsole()
{
	HWND hWnd = GetConsoleWindow();
	ShowWindow(hWnd, SW_MINIMIZE);
	ShowWindow(hWnd, SW_HIDE);
}


int main()
{
	HideConsole();
	wchar_t bot_id[50];
	wchar_t title_new[] = L"Tarlogic: Ragnar Blocker [Event object created]";
	wchar_t title_old[] = L"Tarlogic: Ragnar Blocker [Event object already exists]";
	CalculateBot(bot_id);
	HANDLE hEvent = CreateEventW(0, 1, 0, bot_id);
	if (hEvent == NULL) {
		wprintf(L"[-] Failed to get an event handler: %ld", GetLastError());
		exit(1);
	}

	if (GetLastError() == 183)
	{
		MessageBox(NULL, bot_id, title_old, MB_ICONEXCLAMATION | MB_OK);
		return 0;
	}
	else
		MessageBox(NULL, bot_id, title_new, MB_ICONEXCLAMATION | MB_OK);

	Sleep(INFINITE);
}